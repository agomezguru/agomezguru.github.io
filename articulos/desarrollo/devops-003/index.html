<!doctype html><html lang=es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Despliegue Blue/Green en un entorno de nube."><meta name=generator content="Hugo 0.109.0"><title>Despliegue Blue/Green | GitHub Blog</title><link rel=canonical href=https://agomezguru.github.io/articulos/desarrollo/devops-003/><link href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;500;600;700&display=swap" rel=stylesheet><link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800&display=swap" rel=stylesheet><link rel=stylesheet href=https://agomezguru.github.io/css/style-liberty.css><meta property="og:title" content="Despliegue Blue/Green"><meta property="og:description" content="Despliegue Blue/Green en un entorno de nube."><meta property="og:type" content="article"><meta property="og:url" content="https://agomezguru.github.io/articulos/desarrollo/devops-003/"><meta property="og:image" content="https://agomezguru.github.io/articulos/desarrollo/devops-003/cover.jpg"><meta property="article:section" content="articulos"><meta property="article:published_time" content="2023-04-14T16:12:31-06:00"><meta property="article:modified_time" content="2023-04-14T16:12:31-06:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://agomezguru.github.io/articulos/desarrollo/devops-003/cover.jpg"><meta name=twitter:title content="Despliegue Blue/Green"><meta name=twitter:description content="Despliegue Blue/Green en un entorno de nube."></head><body><header class=w3l-header><nav class="navbar navbar-expand-lg navbar-light fill px-lg-0 py-0 px-3"><div class=container><a class=navbar-brand href=https://agomezguru.github.io><span class="fa fa-pencil-square-o"></span>GitHub Blog</a>
<button class="navbar-toggler collapsed" type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class="fa icon-expand fa-bars"></span>
<span class="fa icon-close fa-times"></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto"><li class="nav-item active"><a class=nav-link href=/>Inicio</a></li><li class="nav-item dropdown @@category__active"><a class="nav-link dropdown-toggle" href id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Artículos <span class="fa fa-angle-down"></span></a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class="dropdown-item @@ls__active" href=/articulos/desarrollo/>Desarrollo</a>
<a class="dropdown-item @@ls__active" href=/articulos/inteligencia_artificial/>Inteligencia artificial</a></div></li><li class="nav-item active"><a class=nav-link href=/more>Ver más</a></li><li class="nav-item active"><a class=nav-link href=/contacto>Contáctame</a></li></ul><div class="search-right mt-lg-0 mt-2"><a href=#search title=search><span class="fa fa-search" aria-hidden=true></span></a><div id=search class=pop-overlay><div class=popup><h3 class="hny-title two">Búsqueda</h3><form action=search-results.html method=get class=search-box><input type=search placeholder="Buscar entradas de blog" name=search required autofocus>
<button type=submit class=btn>Buscar</button></form><a class=close href=#close>×</a></div></div></div><div class="header-author d-flex ml-lg-4 pl-2 mt-lg-0 mt-3"><a class="img-circle img-circle-sm" href=/acerca_de><img src=/images/agomezguru_hu9c1ce3421dee7158921185cdd344cfa2_12722_60x0_resize_q75_h2_box.webp class=img-fluid alt=agomezguru_author_icon></a><div class="align-self ml-3"><a href=/acerca_de><h5>agomezguru</h5></a><span>Autor del Blog</span></div></div></div><div class=mobile-position><nav class=navigation><div class=theme-switch-wrapper><label class=theme-switch for=checkbox><input type=checkbox id=checkbox><div class=mode-container><i class=gg-sun></i>
<i class=gg-moon></i></div></label></div></nav></div></div></nav></header><nav id=breadcrumbs class=breadcrumbs><div class="container page-wrapper"><a href=https://agomezguru.github.io/>GitHub Blog</a>
/&nbsp;
<a href=https://agomezguru.github.io/articulos/>Artículos</a>
/&nbsp;
<a href=https://agomezguru.github.io/articulos/desarrollo/>Desarrollo</a>
/
<span class=breadcrumb_last aria-current=page>Despliegue Blue/Green</span></div></nav><main id=content><div class="py-5 w3l-homeblock1 text-center"><div class="container mt-md-3"><h3 class="blog-desc-big text-center mb-4">Despliegue Blue/Green</h3><div class=blog-post-align><div class=blog-post-img><a href=/acerca_de><img src=/images/agomezguru_hu9c1ce3421dee7158921185cdd344cfa2_12722_60x0_resize_q75_h2_box.webp alt=agomezguru_blog_image class="rounded-circle img-fluid"></a></div><div class=blog-post-info><div class="author align-items-center mb-1"><a href=/acerca_de>Publicado: April 14, 2023</a> en
<a href=/etiquetas/devops>DevOps</a>
<a href=/etiquetas/deployment>Deployment</a>
<a href=/etiquetas/terraform>Terraform</a></div><ul class=blog-meta><li class="meta-item blog-lesson"><span class=meta-value>April 21, 2023</span></li><li class="meta-item blog-students"><span class=meta-value>Lectura: 13 mins.</span></li></ul></div></div></div></div><section class="blog-post-main w3l-homeblock1"><article class="blog-content-inf pb-5"><div class="container pb-lg-4"><div class=single-post-image><div class=post-content><img src=https://agomezguru.github.io/articulos/desarrollo/devops-003/cover_huab8fd7f77e81c4ff4a204b8551be9336_32551_1150x0_resize_q75_h2_box.webp width=1150 loading=lazy class="radius-image img-fluid mb-5" alt="Despliegue Blue/Green"></div></div><div class=single-post-content><p class="alphabet mb-4"><span class=big-letter>E</span>s curioso como ciertas ideas florecen de manera simultánea en varias mentes, no si esto tenga relación con lo que se conoce como conciencia colectiva o sea más afín al bulo Efecto del centésimo mono, pero algo así me ocurrió con los despliegues blue/green.</p><p class=mb-4>Si saberlo ideé una forma de lograr poner en producción un nuevo servidor con un <a href=https://blog.infraspeak.com/es/mttr/>MTTR</a> o con un <a href=#descripci%C3%B3n-del-problema>tiempo de inactividad</a> de cero, ya que muy frecuentemente el código, algún elemento de la pila o el propio sistema operativo cambian, siempre resulta muy engorroso programar dichos cambios a horas del menor tráfico posible (usualmente en la madrugada o en días de asueto), en especial en los tiempos en que todo se realizaba de forma manual y no existián las técnicas de modernas de despliegue DevOps. En fin, lo que se me ocurrió hace ya 14 meses, en realidad fué inventado desde tiempo atrás y descrito por primera vez, hasta donde tengo conocimiento, en el libro <em>Continuous Delivery</em> de la autoría de Jez Humble y David Farley.</p><p class=mb-4>Una de las mayores ventajas de la nube es que los costos son flexibles, así apoyados con las herramientas de <a href=https://learn.microsoft.com/es-es/devops/deliver/what-is-infrastructure-as-code>IaC</a> como <a href=https://www.terraform.io/>Terraform</a> podemos hacer cosas inimaginables hace poco tiempo a un costo irrisorio. Este es el caso de los despliegues Blue/Green.</p><h3 id=descripción-del-problema class="blog-desc-big m-0 mb-4">Descripción del problema</h3><p class=mb-4>Para entender cabalmente el problema que estamos intentando resolver con el <a href=https://historiadelaempresa.com/caso-de-uso>caso de uso</a> típico de los despliegues Blue/Green, voy a definir primero <em>tiempo de inactividad</em> como un período en el que un sistema no está disponible. Puede aplicarse a cualquier computadora o red, pero se emplea más comúnmente en referencia a servidores. En particular, la confiabilidad del servidor de aplicaciones web a menudo se mide en términos de tiempo de inactividad, donde lo ideal es poco o ningún tiempo de inactividad.</p><p>Algunas de las razones por las que un servidor puede experimentar tiempo de inactividad son:</p><div class="text-list-gray mb-4"><ul><li><strong>Reinicio del servidor:</strong> reiniciar un servidor puede requerir unos minutos de tiempo de inactividad porque el sistema debe apagarse, reiniciarse y luego reiniciar los procesos necesarios para responder a las solicitudes entrantes.</li><li><strong>Reinicio del software:</strong> reiniciar un proceso, como Apache en un servidor web, puede causar algunos segundos de tiempo de inactividad mientras se reinicia el proceso.</li><li><strong>Desconexión de la red:</strong> si un servidor se desconecta físicamente de una red, los sistemas de la red no podrán acceder a él.</li><li><strong>Interrupción de la red:</strong> si alguna parte de una red (incluida Internet) no funciona entre el servidor y el cliente, el cliente no podrá comunicarse con el servidor.</li><li><strong>Sobrecarga de tráfico:</strong> si un servidor recibe más tráfico del que puede manejar, no podrá responder a todas las solicitudes. Los usuarios pueden experimentar tiempo de inactividad hasta que el tráfico disminuya. Esto puede deberse a un pico en el tráfico o a un ataque DDoS (Denegación de Servicio).</li><li><strong>Falla de hardware:</strong> si falla un componente de hardware importante, como un HDD o una SSD, es posible que el servidor deje de funcionar.</li><li><strong>Falla de software:</strong> si un proceso en un servidor, como el servicio httpd (HTTP), deja de ejecutarse, hará que el servidor no responda a las solicitudes hasta que se reinicie el proceso.</li><li><strong>Corte de energía:</strong> si se corta la energía eléctrica y no hay energía de respaldo disponible (por ejemplo, un generador o UPS), los sistemas afectados estarán fuera de línea hasta que se restablezca la energía.</li><li><strong>Ataque de piratas informáticos:</strong> si un pirata informático obtiene el control de un servidor, puede impedir el acceso a los servicios necesarios y hacer que el servidor deje de responder.</li></ul></div><p class=mb-4>Si desde siempre la redundancia, como los sistemas de almacenamiento RAID y los generadores de energía de respaldo nos han ayudado a evitar el tiempo de inactividad debido a una falla del hardware, por que no extender el mismo concepto a todo el servidor, la respuesta: <em>Costos $$$</em>, hasta ahora.</p><p class=mb-4>Si nuestra labor como <a href=https://www.ibm.com/mx-es/topics/site-reliability-engineering>ingenieros de confiabilidad del sitio</a> es mantener los SLA&rsquo;s acordados, ello implicará siempre, de manera intrínseca, minimizar el tiempo de inactividad tanto como sea posible. Aún cuando en promedio durante los últimos dos años los niveles alcanzados de <a href=https://elviajedelcliente.com/sla/>disponibilidad en mis servicios son 99.98%</a>, había ocasiones en que el tiempo de inactividad era inevitable. Por ejemplo, al realizar una migración del servicio a una nueva versión incompatible que requiere de hacer un respaldo a la base de datos, realizar la migración de esos datos a la nueva versión, ejecutar rápidamente un <a href=https://es.wikipedia.org/wiki/Pruebas_de_humo>smoking test</a>, etc. pueden ser necesarios varios minutos o incluso algunas horas de tiempo de inactividad. Este tipo de <em>tiempo de inactividad planificado</em> generalmente se programa para las primeras horas de la madrugada o en días no laborables cuando los niveles de tráfico son más bajos.</p><p class=mb-4>Otro <a href=https://historiadelaempresa.com/caso-de-uso>caso de uso</a> bastante recurrente es ocasionado, paradójicamente por la propia solución, pues todos los <a href=https://registry.terraform.io/browse/providers>proveedores (providers)</a> de Terraform están actualizando sus versiones a una velocidad alucinante. En un afán de sacarle media cabeza a su más cercano competidor y en lo pones en práctica lo descrito en este blog, seguramente ya salieron a la luz del sol nuevas características, mejoras, bugfixes, etc. y eso se refleja en las versiones de cada provider.</p><p class=mb-4>Pues bien, lo último que deseas hacer es <em>experimentar</em> con el ambiente de producción y es aquí donde entra en escena por segunda ocasión los despliegues Blue/Green, por ejemplo: si hace unos tres meses que desplegaste la última versión de tu infraestructura, seguramente todo la pila que sustenta tu software ya sufrió modificaciones, empezando por el sistema operativo, los <a href=https://es.abcdef.wiki/wiki/Artifact_(software_development)>artefactos</a>, ya surgieron nuevas funcionalidades experimentales y un largo etcétera.</p><p class=mb-4>Por ejemplo, recién leyendo el <a href=https://www.techrepublic.com/article/nala-apt-package-manager/>sig. artículo</a>, se me hizo interesante probar lo expuesto por el autor (muchas veces les pagan comisión por escribirlos y, a la hora de la verdad&mldr;), para ello te mostraré los pasos generales a seguir para que logres hacer un despliegue Blue/Green de prueba y si todo funciona como se espera, podría ser tu siguiente gran mejora, que en realidad se compondrá de muchas pequeñas mejoras que sucedieron simultáneamente, pero primero vamos a conceptualizar lo que deseamos lograr.</p><h3 id=despliegue-bluegreen-como-alternativa-de-solución class="blog-desc-big m-0 mb-4">Despliegue Blue/Green como alternativa de solución</h3><p class=mb-4>Con todo lo hasta ahora expuesto podemos definir un despliegue Blue/Green, como la implementación de una estrategia de despliegue de servicios y/o aplicaciones Web en producción, que permite actualizarlas de forma segura sin tiempo de inactividad.</p><p class=mb-4>Este proceso implica la creación de dos instancias idénticas de producción detrás de un balanceador de carga (load balancer). En cualquier momento, una aplicación responde al tráfico de usuarios, mientras que la otra recibe actualizaciones constantes del servidor de integración continua (CI) del equipo de desarrollo.</p><p class=mb-4>Dependiendo de tu presupuesto puedes mantener la segunda instancia prendida permanentemente, en reposo o como unas cuantas líneas de infraestructura como código con un costo de cero. Este es casi siempre mi caso, ya que poner en operación una nueva instancia con todo lo requerido en la actualidad no me toma más de 5 minutos.</p><p class=mb-4>Cuando el equipo de trabajo requiere <em>desplegar</em> nuevas funciones, cambia la ruta en el balanceador de carga de la versión anterior de su aplicación a la nueva versión. En ese momento, el servidor CI envía actualizaciones a la aplicación que ya no recibe tráfico del enrutador.</p><figure class="image-fluid mb-3"><img src=blue-green-deployment-model.gif></figure><p class=mb-4>Cabe anotar que esta solución aplica solo a servicios desplegados en nube, virtualizados o en contenedores, en el sentido de que su infraestructura debe ser automatizable para que el enfoque tenga sentido.</p><p class=mb-4>A los despliegues Blue/Green también se les conoce como el Red/Black, ya que representan el mismo concepto. Si bien el primero es el término más común, el segundo parece haberlo popularizado Netflix en sus herramientas (como Spinnaker).</p><h3 id=diseño-conceptual-de-un-despliegue-bluegreen class="blog-desc-big m-0 mb-4">Diseño conceptual de un despliegue Blue/Green</h3><blockquote class="blockquote my-5"><div class=icon-quote><span class="fa fa-quote-left" aria-hidden=true></span></div>Advertencia: Lo primero que te recomiendo es nunca, nunca experimentar con software que ya tienes puesto en producción, para ello está la nube. En ella, con ayuda de las herramientas adecuadas como las descritas en este blog, podrás crear proyectos completos, con una o decenas de instancias en tiempo récord y un costos extremedamente bajos.</blockquote><div class="text-list mb-4"><ol><li>El servidor de producción Blue se encuentra activo</li><li>Los nuevos cambios de código se despliegan en el servidor de producción Green, al que no se puede acceder públicamente a través de la CDN</li><li>Aprobados los cambios y ya listos para lanzar una nueva versión, pasamos del entorno Blue al entorno Green</li><li>El ambiente Green está ahora activo y es quién recibe el tráfico externo. El servidor Blue puede quedar prendido por un tiempo razonable como plan de RollBack y después puede ser apagado o incluso destruido para no incurrir en costos adicionales.</li><li>Cuando el equipo de desarrollo o el de operaciones desee realizar un nuevo cambio o probar una funcionalidad nueva, se enciende o recrea el servidor de producción Blue, según sea el caso y se repite este flujo de trabajo, pero en orden inverso, con el servidor de producción Green activo.</li></ol></div><div class="sing-post-thumb mb-5 row pt-3"><div class="col-sm-6 mt-sm-0 mt-3"><a href=#url><img src=https://agomezguru.github.io/articulos/desarrollo/devops-003/inner-bg1_hu76905d0fb31c502421d4798cb05dbd1a_953376_545x0_resize_q75_h2_box_3.webp loading=lazy class="radius-image img-fluid" alt></a></div><div class="col-sm-6 mt-sm-0 mt-3"><a href=#url><img src=https://agomezguru.github.io/articulos/desarrollo/devops-003/inner-bg2_hue6ca7022504dad3f9b6d775606f2162e_970266_545x0_resize_q75_h2_box_3.webp loading=lazy class="radius-image img-fluid" alt></a></div></div><h4 id=prerrequisitos class="blog-desc-big m-0 mb-4">Prerrequisitos</h4><div class="text-list mb-4"><ul><li>Tener una cuenta en la nube de tu preferencia</li><li>Herramienta de Infraestructura como Código: <a href=https://www.terraform.io/>Terraform</a></li><li>Servidor DNS público administrable como <a href=https://registry.terraform.io/browse/providers>Terraform Provider</a></li><li>Dos instancias idénticas de cómputo en nube</li><li>Un dominio web de tu propiedad</li></ul></div><p class=mb-4>Una de las grandes ventajas de <a href=https://www.terraform.io/>Terraform</a> como herramienta <a href=https://learn.microsoft.com/es-es/devops/deliver/what-is-infrastructure-as-code>IaC</a> es la modularización de tu infraestructura, yo tengo ya muy estandarizado el proceso con mis propios módulos para la creación de los propios proyectos, otro para el entorno de red y así sucesivamente para las instancias de cómputo, la CDN, etc.</p><p class=mb-4>Como sé que ya llevas algunos años puliendo tu infraestructura en nube, solo necesitamos alterar tres partes de la misma para lograr nuestro cometido: El módulo de red, el de la CDN y agregar unas cuantas variables de inicialización de tus proyectos.</p><h4 id=el-módulo-de-red class="blog-desc-big m-0 mb-4">El módulo de red</h4><p class=mb-4>Aquí lo que necesitamos es muy simple, solo dos IP&rsquo;s públicas accesibles desde la CDN. Para lograrlo de una manera simple, agregué una variable en el archivo de configuración del proyecto, el código se ve así:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>  # Set static IPs for the instances
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>  variable</span> <span style=color:#4070a0>&#34;required_ips&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>type</span>        = number
</span></span><span style=display:flex><span>    <span style=color:#4070a0>description</span> = <span style=color:#4070a0>&#34;Number of required IPs&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>default</span>     = <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    validation {
</span></span><span style=display:flex><span>      <span style=color:#4070a0>condition</span>     = <span style=color:#007020>var</span>.required_ips <span style=color:#666>&gt;</span> <span style=color:#40a070>0</span> <span style=color:#666>&amp;&amp;</span> <span style=color:#007020>var</span>.required_ips <span style=color:#666>&lt;</span> <span style=color:#40a070>4</span>
</span></span><span style=display:flex><span>      <span style=color:#4070a0>error_message</span> = <span style=color:#4070a0>&#34;Please provide a valid number of required public IPs. Options are: 1, 2 or 3.&#34;</span>
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p class="mt-4 mb-4">Y en main.tf el código queda así:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>  # Generate a random name for external IP address
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>  resource</span> <span style=color:#4070a0>&#34;random_string&#34;</span> <span style=color:#4070a0>&#34;ext_address&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>count</span>   = <span style=color:#40a070>3</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>length</span>  = <span style=color:#40a070>4</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>upper</span>   = <span style=color:#007020;font-weight:700>false</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>numeric</span> = <span style=color:#007020;font-weight:700>true</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>lower</span>   = <span style=color:#007020;font-weight:700>true</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>special</span> = <span style=color:#007020;font-weight:700>false</span>
</span></span><span style=display:flex><span>  }<span style=color:#60a0b0;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>  # Create external IP for world accesss to server&#39;s 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>  resource</span> <span style=color:#4070a0>&#34;google_compute_address&#34;</span> <span style=color:#4070a0>&#34;external_ip_address&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>count</span>        = <span style=color:#007020>var</span>.required_ips
</span></span><span style=display:flex><span>    <span style=color:#4070a0>project</span>      = <span style=color:#007020>var</span>.project_id
</span></span><span style=display:flex><span>    <span style=color:#4070a0>region</span>       = <span style=color:#007020>var</span>.region
</span></span><span style=display:flex><span>    <span style=color:#4070a0>name</span>         = <span style=color:#4070a0>&#34;fixed-external-ip-</span><span style=color:#70a0d0>${</span>random_string.ext_address[<span style=color:#007020>count</span>.index].result<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>address_type</span> = <span style=color:#4070a0>&#34;EXTERNAL&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p class="mt-4 mb-4">Así siempre dispongo de una, dos o tres IP&rsquo;s dependiendo el número de instancias a ejecutar en un momento dado. Dos para los servidores de producción Green/Blue y una extra para el servidor de CI y Staging cuando el proyecto se encuentra en sus fases iniciales.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#007020;font-weight:700>  output</span> <span style=color:#4070a0>&#34;external_ip_0&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>value</span> = google_compute_address.external_ip_address[<span style=color:#40a070>0</span>].address
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>
</span></span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>  output</span> <span style=color:#4070a0>&#34;external_ip_1&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>value</span> = <span style=color:#007020>var</span>.required_ips <span style=color:#666>&gt;=</span> <span style=color:#40a070>2</span> <span style=color:#666>?</span> google_compute_address.external_ip_address[<span style=color:#40a070>1</span>].address<span style=color:#666>:</span> <span style=color:#4070a0>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>
</span></span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>  output</span> <span style=color:#4070a0>&#34;external_ip_2&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>value</span> = <span style=color:#007020>var</span>.<span style=color:#4070a0>required_ips</span> =<span style=color:#666>=</span> <span style=color:#40a070>3</span> <span style=color:#666>?</span> google_compute_address.external_ip_address[<span style=color:#40a070>2</span>].address<span style=color:#666>:</span> <span style=color:#4070a0>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p class="mt-4 mb-4">Las IP&rsquo;s públicas creadas por mi módulo las devuelvo a través del propio mecanismo de salida de Terraform mediante el archivo outputs.tf mostrado.</p><h4 id=el-módulo-de-cdn class="blog-desc-big m-0 mb-4">El módulo de CDN</h4><p class=mb-4>La mayoría de mis clientes me solicitan sitios web para la publicación de contenido accesibles por miles de lectores, ello en el pasado me condujo a seleccionar un proveedor de red de distribución de contenidos o CDN. Así, para hacerme la vida más fácil, siempre la pongo al frente de todos mis despliegues en Web.</p><p class=mb-4>En mi caso muy particular, la conmutación entre los servidores Green/Blue sucede en la CDN y no en el propio balanceador de carga, como lo encontrás detallado en la mayor parte de la literatura al respecto. Lo implementé así por que mi propio balanceador de carga (load balancer) está detrás de la CDN, de forma que el público siempre ve las IP&rsquo;s públicas de la CDN, nunca las de mi infraestructura. Una vez aclarado el punto, lo que yo hago es simplemente alterar los registros DNS para que apunten ya sea a la IP del servidor Blue o el Green, dependiendo de cuál se encuentre en operación en determinado momento.</p><p class=mb-4>Como tengo por costumbre probar exhaustivamente cualquier idea que se me ocurra, lo cual te recomiendo encarecidamente, hice una copia de todo mi módulo para no afectar los proyectos puestos actualmente en producción, ya que todos sin excepción hacen uso de él. A la nueva copia la nombré siguiendo la conveción estándar de <a href=https://semver.org/lang/es/>versionado semántico 2.0.0</a>.</p><p class=mb-4>Una vez clonado, lo primero hice fue alterar el código de la CDN para que apunte correctamente al servidor activo. Lo hice pasando una variable de tipo map a Terraform con todos los parámetros necesarios, al final mi código quedó así:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#007020;font-weight:700>  variable</span> <span style=color:#4070a0>&#34;prod_enabled&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>type</span>        = object(
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        .
</span></span><span style=display:flex><span>        .
</span></span><span style=display:flex><span>        .<span style=color:#60a0b0;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>        # Actual IP public address
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#4070a0>ip</span>            = string<span style=color:#60a0b0;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>        # Backend servers blue/green configuration
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#4070a0>blue_svr</span>      = bool
</span></span><span style=display:flex><span>        <span style=color:#4070a0>blue_svr_ip</span>   = string
</span></span><span style=display:flex><span>        <span style=color:#4070a0>green_svr</span>     = bool
</span></span><span style=display:flex><span>        <span style=color:#4070a0>green_svr_ip</span>  = string
</span></span><span style=display:flex><span>        <span style=color:#4070a0>server_active</span> = string
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#4070a0>description</span> = <span style=color:#4070a0>&#34;Enable access to production environment with blue/green servers&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>default</span>     =  {
</span></span><span style=display:flex><span>      .
</span></span><span style=display:flex><span>      .
</span></span><span style=display:flex><span>      .
</span></span><span style=display:flex><span>      <span style=color:#4070a0>ip</span>            = <span style=color:#4070a0>&#34;&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#4070a0>blue_svr</span>      = <span style=color:#007020;font-weight:700>false</span>
</span></span><span style=display:flex><span>      <span style=color:#4070a0>blue_svr_ip</span>   = <span style=color:#4070a0>&#34;&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#4070a0>green_svr</span>     = <span style=color:#007020;font-weight:700>false</span>
</span></span><span style=display:flex><span>      <span style=color:#4070a0>green_svr_ip</span>  = <span style=color:#4070a0>&#34;&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#4070a0>server_active</span> = <span style=color:#4070a0>&#34;&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p class="mt-4 mb-4">Donde <strong>ip</strong> me permite controlar la IP del servidor que está actualmente activo, tal como se muestra en el siguiente trozo de código:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#007020;font-weight:700>  resource</span> <span style=color:#4070a0>&#34;cloudflare_record&#34;</span> <span style=color:#4070a0>&#34;backend_blue_access&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>count</span>   = <span style=color:#007020>var</span>.prod_enabled.<span style=color:#4070a0>blue_svr</span> =<span style=color:#666>=</span> <span style=color:#007020;font-weight:700>true</span> <span style=color:#666>?</span> <span style=color:#40a070>1</span><span style=color:#666>:</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>name</span>    = <span style=color:#007020>var</span>.cf_cdn.<span style=color:#4070a0>new_zone</span> =<span style=color:#666>=</span> <span style=color:#007020;font-weight:700>true</span> <span style=color:#666>?</span> <span style=color:#4070a0>&#34;backend-blue-access.</span><span style=color:#70a0d0>${</span><span style=color:#007020>var</span>.cf_cdn.zone_name<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span><span style=color:#666>:</span> <span style=color:#4070a0>&#34;backend-blue-access.</span><span style=color:#70a0d0>${</span><span style=color:#007020>var</span>.prod_enabled.env_name<span style=color:#70a0d0>}</span><span style=color:#4070a0>.</span><span style=color:#70a0d0>${</span><span style=color:#007020>var</span>.cf_cdn.zone_name<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>value</span>   = <span style=color:#007020>var</span>.prod_enabled.<span style=color:#4070a0>server_active</span> =<span style=color:#666>=</span> <span style=color:#4070a0>&#34;blue&#34;</span> <span style=color:#666>?</span> <span style=color:#007020>var</span>.cf_cdn.<span style=color:#4070a0>new_zone</span> =<span style=color:#666>=</span> <span style=color:#007020;font-weight:700>true</span> <span style=color:#666>?</span> <span style=color:#007020>var</span>.cf_cdn.zone_name<span style=color:#666>:</span> <span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>${</span><span style=color:#007020>var</span>.prod_enabled.env_name<span style=color:#70a0d0>}</span><span style=color:#4070a0>.</span><span style=color:#70a0d0>${</span><span style=color:#007020>var</span>.cf_cdn.zone_name<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>:</span> <span style=color:#007020>var</span>.prod_enabled.blue_svr_ip
</span></span><span style=display:flex><span>    <span style=color:#4070a0>type</span>    = <span style=color:#007020>var</span>.prod_enabled.<span style=color:#4070a0>server_active</span> =<span style=color:#666>=</span> <span style=color:#4070a0>&#34;blue&#34;</span> <span style=color:#666>?</span> <span style=color:#4070a0>&#34;CNAME&#34;</span> <span style=color:#666>:</span> <span style=color:#4070a0>&#34;A&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>proxied</span> = <span style=color:#007020;font-weight:700>false</span><span style=color:#60a0b0;font-style:italic> # This value is always false to get access.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  }
</span></span></code></pre></div><p class="mt-4 mb-4">El mismo código se repite idéntico para el servidor <em>Green</em> alterando los valores correspondientes:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#007020;font-weight:700>  resource</span> <span style=color:#4070a0>&#34;cloudflare_record&#34;</span> <span style=color:#4070a0>&#34;backend_green_access&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>count</span>   = <span style=color:#007020>var</span>.prod_enabled.<span style=color:#4070a0>green_svr</span> =<span style=color:#666>=</span> <span style=color:#007020;font-weight:700>true</span> <span style=color:#666>?</span> <span style=color:#40a070>1</span><span style=color:#666>:</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>name</span>    = <span style=color:#007020>var</span>.cf_cdn.<span style=color:#4070a0>new_zone</span> =<span style=color:#666>=</span> <span style=color:#007020;font-weight:700>true</span> <span style=color:#666>?</span> <span style=color:#4070a0>&#34;backend-green-access.</span><span style=color:#70a0d0>${</span><span style=color:#007020>var</span>.cf_cdn.zone_name<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span><span style=color:#666>:</span> <span style=color:#4070a0>&#34;backend-green-access.</span><span style=color:#70a0d0>${</span><span style=color:#007020>var</span>.prod_enabled.env_name<span style=color:#70a0d0>}</span><span style=color:#4070a0>.</span><span style=color:#70a0d0>${</span><span style=color:#007020>var</span>.cf_cdn.zone_name<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>value</span>   = <span style=color:#007020>var</span>.prod_enabled.<span style=color:#4070a0>server_active</span> =<span style=color:#666>=</span> <span style=color:#4070a0>&#34;green&#34;</span> <span style=color:#666>?</span> <span style=color:#007020>var</span>.cf_cdn.<span style=color:#4070a0>new_zone</span> =<span style=color:#666>=</span> <span style=color:#007020;font-weight:700>true</span> <span style=color:#666>?</span> <span style=color:#007020>var</span>.cf_cdn.zone_name<span style=color:#666>:</span> <span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>${</span><span style=color:#007020>var</span>.prod_enabled.env_name<span style=color:#70a0d0>}</span><span style=color:#4070a0>.</span><span style=color:#70a0d0>${</span><span style=color:#007020>var</span>.cf_cdn.zone_name<span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>:</span> <span style=color:#007020>var</span>.prod_enabled.green_svr_ip
</span></span><span style=display:flex><span>    <span style=color:#4070a0>type</span>    = <span style=color:#007020>var</span>.prod_enabled.<span style=color:#4070a0>server_active</span> =<span style=color:#666>=</span> <span style=color:#4070a0>&#34;green&#34;</span> <span style=color:#666>?</span> <span style=color:#4070a0>&#34;CNAME&#34;</span> <span style=color:#666>:</span> <span style=color:#4070a0>&#34;A&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>proxied</span> = <span style=color:#007020;font-weight:700>false</span><span style=color:#60a0b0;font-style:italic> # This value is always false to get access.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  }
</span></span></code></pre></div><p class="mt-4 mb-4">Si eres perspicaz habrás notado que en la línea 6 altero el tipo del registro DNS y lo cambio de CNAME a tipo A, esto también lo hago en el registro root del proyecto:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#007020;font-weight:700>  resource</span> <span style=color:#4070a0>&#34;cloudflare_record&#34;</span> <span style=color:#4070a0>&#34;root&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>count</span>   = <span style=color:#007020>var</span>.prod_enabled.<span style=color:#4070a0>on</span> =<span style=color:#666>=</span> <span style=color:#007020;font-weight:700>true</span> <span style=color:#666>?</span> <span style=color:#007020>var</span>.cf_cdn.<span style=color:#4070a0>new_zone</span> =<span style=color:#666>=</span> <span style=color:#007020;font-weight:700>true</span> <span style=color:#666>?</span> <span style=color:#40a070>1</span><span style=color:#666>:</span> <span style=color:#40a070>0</span> <span style=color:#666>:</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>name</span>    = <span style=color:#4070a0>&#34;@&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>value</span>   = <span style=color:#007020>var</span>.prod_enabled.ip
</span></span><span style=display:flex><span>    <span style=color:#4070a0>type</span>    = <span style=color:#4070a0>&#34;A&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#4070a0>proxied</span> = <span style=color:#007020;font-weight:700>true</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p class="mt-4 mb-4">Con ello garantizo que la CDN siempre apunte a la IP pública del servidor activo.</p><h4 id=las-instancias-de-cómputo class="blog-desc-big m-0 mb-4">Las instancias de cómputo</h4><p class="mt-4 mb-4">Ahora solo resta controlar qué instancia está prendida en un determinado momento, ello lo logro con estas tres variables en el archivo de configuración de mi proyecto (defaults.auto.tfvars):</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span>  <span style=color:#4070a0>blue_enabled</span>  = <span style=color:#007020;font-weight:700>true</span>
</span></span><span style=display:flex><span>  <span style=color:#4070a0>green_enabled</span> = <span style=color:#007020;font-weight:700>true</span>
</span></span><span style=display:flex><span>  <span style=color:#4070a0>server_active</span> = <span style=color:#4070a0>&#34;blue&#34;</span><span style=color:#60a0b0;font-style:italic> # &#34;green&#34;
</span></span></span></code></pre></div><p class="mt-4 mb-4">Ya dentro del archivo de configuración de las instancias las empleo de la siguiente manera:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#007020;font-weight:700>  module</span> <span style=color:#4070a0>&#34;blue_server&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>count</span>   = <span style=color:#007020>var</span>.<span style=color:#4070a0>blue_enabled</span> =<span style=color:#666>=</span> <span style=color:#007020;font-weight:700>true</span> <span style=color:#666>?</span> <span style=color:#40a070>1</span> <span style=color:#666>:</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>    .
</span></span><span style=display:flex><span>    .
</span></span><span style=display:flex><span>    .
</span></span><span style=display:flex><span>    <span style=color:#4070a0>ext_ip</span>  = <span style=color:#007020>module</span>.network.external_ip_0
</span></span><span style=display:flex><span>    .
</span></span><span style=display:flex><span>    .
</span></span><span style=display:flex><span>    .
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p class="mt-4 mb-4">Mismo código para el servidor <em>Green</em>, solo cambia la variable <em>var.green_enabled</em>. El valor de la IP pública que verá la CDN lo obtengo del <a href=#el-m%C3%B3dulo-de-red>módulo de red</a>.</p><h3 id=conclusión class="blog-desc-big m-0 mb-4">Conclusión</h3><p class=mb-4>Despliegues simples, rollback&rsquo;s rápidos y la fácil recuperación ante desastres son los beneficios clave de la técnica de despliegue Blue/Green, si quieres ahondar aún más en los beneficios y algunos inconvenientes de esta técnica, consulta la siguiente sección.</p><h3 id=referencias class="blog-desc-big m-0 mb-4">Referencias</h3><div class="text-list mb-4"><ul><li><p><a href=https://www.redhat.com/en/topics/devops/what-is-blue-green-deployment>What is blue green deployment?</a></p></li><li><p><a href=https://www.atatus.com/glossary/blue-green-deployment/>Blue-Green Deployment</a></p></li><li><p><a href=https://medium.com/devopslatam/introducci%C3%B3n-a-los-despliegues-azul-verde-bb4055811279>Introducción a los despliegues Azul-Verde</a></p></li></ul></div><h3 id=créditos class="blog-desc-big m-0 mb-4">Créditos</h3><div class="text-list-gray mb-4"><ul class=mb-4><li>Figura de portada. Originalmente publicada en <a href=https://www.atatus.com/glossary/blue-green-deployment/>Blue-Green Deployment</a></li></ul><ul class=mb-4><li>Animación. Originalmente publicada en <a href=https://www.redhat.com/en/topics/devops/what-is-blue-green-deployment>www.redhat.com</a></li></ul><ul><li>Figura 1 y 2. Originalmente publicada en <a href=https://medium.com/devopslatam/introducci%C3%B3n-a-los-despliegues-azul-verde-bb4055811279>Introducción a los despliegues Azul-Verde</a></li></ul></div><div class="d-grid left-right mt-5 pb-md-5"><div class="buttons-singles tags"><h4>Etiquetas :</h4><a href=/etiquetas/devops>DevOps</a>
<a href=/etiquetas/deployment>Deployment</a>
<a href=/etiquetas/terraform>Terraform</a></div><div class=buttons-singles><h4>Compartir :</h4><a href=https://www.linkedin.com/in/alejandro-gomez-lagunas-12748212/><span class="fa fa-linkedin" aria-hidden=true></span></a>
<a href=https://github.com/agomezguru><span class="fa fa-github" aria-hidden=true></span></a>
<a href=mailto:alagunas@coati.com.mx><span class="fa fa-envelope" aria-hidden=true></span></a></div></div></div></div></article></section></main><footer class=w3l-footer-16><div class="footer-content py-lg-5 py-4 text-center"><div class=container><div class=copy-right><h6>© 2023 GitHub Blog: Made with <span class="fa fa-heart" aria-hidden=true></span>;
Coded with <a href=https://gohugo.io/>Hugo</a>; Designed by <a href=https://w3layouts.com/><strong>W3layouts</strong></a></h6></div><ul class="author-icons mt-4"><li><a class=linkedin href=https://www.linkedin.com/in/alejandro-gomez-lagunas-12748212/><span class="fa fa-linkedin" aria-hidden=true></span></a></li><li><a class=github href=https://github.com/agomezguru><span class="fa fa-github" aria-hidden=true></span></a></li><li><a href=mailto:alagunas@coati.com.mx><span class="fa fa-envelope" aria-hidden=true></span></a></li></ul><button onclick=topFunction() id=movetop title="Go to top">
<span class="fa fa-angle-up"></span></button></div></div><script>window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?document.getElementById("movetop").style.display="block":document.getElementById("movetop").style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script></footer><script src=https://agomezguru.github.io/js/theme-change.js></script>
<script src=https://agomezguru.github.io/js/jquery-3.3.1.min.js></script>
<script>$(function(){$(".navbar-toggler").click(function(){$("body").toggleClass("noscroll")})})</script><script src=https://agomezguru.github.io/js/bootstrap.min.js></script></body></html>